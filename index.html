<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Exam Form</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="max-w-3xl w-full space-y-8">
        <!-- Form Container -->
        <div class="bg-white p-8 sm:p-10 shadow-2xl rounded-2xl">
            <header class="text-center mb-8">
                
                <!-- 
                  HOW TO ADD YOUR HEADER IMAGE:
                  I have converted your Google Drive link and placed it in the `src` attribute below.
                -->
                <img src="https://lh3.googleusercontent.com/d/1yXbGlaN3MK7qQqUoxRcCqwAOj_uWvW3b" alt="Form Header" class="mx-auto w-full max-w-lg rounded-md shadow-md">
                
                <p class="mt-4 text-2xl font-semibold text-gray-800">
                    Winter 2025 Backlog Exam Form
                </p>
            </header>

            <!-- Success Message -->
            <div id="successMessage" class="hidden p-4 mb-6 rounded-md bg-green-100 border border-green-300">
                <p class="text-sm font-medium text-green-800">
                    Form submitted successfully! Your response has been recorded.
                </p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden p-4 mb-6 rounded-md bg-red-100 border border-red-300">
                <p class="text-sm font-medium text-red-800">
                    An error occurred. Please try submitting the form again.
                </p>
            </div>

            <!-- The Form -->
            <form id="examForm">
                <div class="space-y-6">

                    <!-- Personal Details Section -->
                    <fieldset class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" name="Name" id="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="prnNumber" class="block text-sm font-medium text-gray-700">PRN No</label>
                            <input type="text" name="PRNNo" id="prnNumber" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email ID</label>
                            <input type="email" name="EmailID" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Mobile No</label>
                            <input type="tel" name="MobileNo" id="phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                    </fieldset>

                    <!-- Academic Details Section -->
                    <fieldset class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
                            <select id="branch" name="Branch" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                                <option value="" disabled selected>Select your branch</option>
                                <option value="Computer">Computer Engineering</option>
                                <option value="Mechanical">Mechanical Engineering</option>
                                <option value="Electrical">Electrical Engineering</option>
                                <option value="Civil">Civil Engineering</option>
                            </select>
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-700">Semester</label>
                            <select id="semester" name="Semester" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                                <option value="" disabled selected>Select your semester</option>
                                <option value="1">Sem I</option>
                                <option value="2">Sem II</option>
                                <option value="3">Sem III</option>
                                <option value="4">Sem IV</option>
                                <option value="5">Sem V</option>
                                <option value="6">Sem VI</option>
                                <option value="7">Sem VII</option>
                                <option value="8">Sem VIII</option>
                            </select>
                        </div>
                        <div>
                            <!-- CRITICAL CHANGE: name="TotalSubjects" changed to name="TotalCourses" -->
                            <label for="totalCourses" class="block text-sm font-medium text-gray-700">Total Courses</label>
                            <input type="number" name="TotalCourses" id="totalCourses" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3" min="1" max="20" disabled>
                            <p class="text-xs text-gray-500 mt-1">This field is updated by the summary.</p>
                        </div>
                    </fieldset>

                    <!-- Dynamic Courses Section -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Courses for Examination</label>
                        <p class="text-sm text-gray-500">Select a branch and semester to see courses. You can switch semesters and your selections will be saved.</p>
                        <div id="coursesContainer" class="mt-2 space-y-4 p-4 border border-gray-200 rounded-md bg-gray-50 min-h-[1Eet.A "Building Materials", code: "CE102" }50px]">
                            <p id="coursesPlaceholder" class="text-sm text-gray-500">Please select your branch and semester first.</p>
                            <!-- Course groups will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- --- NEW: Selected Courses Summary --- -->
                    <div id="summarySection">
                        <label class="block text-sm font-medium text-gray-700">Selected Courses Summary</label>
                        <div id="summaryContainer" class="mt-2 space-y-2 p-4 border border-blue-200 rounded-md bg-blue-50 min-h-[100px]">
                            <p class="text-sm text-gray-500">No courses selected yet.</p>
                        </div>
                    </div>
                    
                    <!-- Submission Button -->
                    <div>
                        <button type="submit" id="submitButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:bg-gray-400">
                            <span id="buttonText">Submit Application</span>
                            <div id="buttonSpinner" class="hidden spinner"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            
            // This is your Google Apps Script URL
            const formScriptURL = 'https://script.google.com/macros/s/AKfycbzc-UsklBLnOqLo8EgHGMMTg2xxA67mNunkf1iJazePTCy0JKLEHxyGHf-JS6E8VIjXJg/exec';

            // --- COURSE DATA (was subjectsByBranchAndSem) ---
            const coursesByBranchAndSem = {
                "Computer": {
                    "1": [
                        { name: "Fundamentals of Programming", code: "CS101" },
                        { name: "Basic Electrical Engineering", code: "EE101" }
                    ],
                    "2": [
                        { name: "Data Structures", code: "CS201" },
                        { name: "Digital Logic Design", code: "CS202" }
                    ],
                    "3": [
                        { name: "Algorithms", code: "CS301" },
                        { name: "Database Systems", code: "CS302" }
                    ],
                    "4": [
                        { name: "Operating Systems", code: "CS401" },
                        { name: "Computer Networks", code: "CS402" }
                    ]
                },
                "Mechanical": {
                    "1": [
                        { name: "Engineering Mechanics", code: "ME101" },
                        { name: "Engineering Drawing", code: "ME102" }
                    ],
                    "2": [
                        { name: "Thermodynamics", code: "ME201" },
                        { name: "Fluid Mechanics", code: "ME202" }
                    ],
                    "3": [
                        { name: "Strength of Materials", code: "ME301" },
                        { name: "Machine Design", code: "ME302" }
                    ]
                },
                "Electrical": {
                    "1": [
                        { name: "Basic Electrical Engineering", code: "EE101" },
                        { name: "Physics", code: "PHY101" }
                    ],
                    "2": [
                        { name: "Circuit Theory", code: "EE201" },
                        { name: "Electromagnetic Fields", code: "EE202" }
                    ],
                    "3": [
                        { name: "Power Systems", code: "EE301" },
                        { name: "Control Systems", code: "EE302" }
                    ]
                },
                "Civil": {
                    "1": [
                        { name: "Engineering Mechanics", code: "CE101" },
                        { name: "Building Materials", code: "CE102" }
                    ],
                    "2": [
                        { name: "Surveying", code: "CE201" },
                        { name: "Structural Analysis", code: "CE202" }
                    ],
                    "3": [
                        { name: "Geotechnical Engineering", code: "CE301" },
                        { name: "Transportation Engineering", code: "CE302" }
                    ]
                }
            };

            // --- ELEMENT REFERENCES (updated) ---
            const form = document.getElementById('examForm');
            const branchSelect = document.getElementById('branch');
            const semesterSelect = document.getElementById('semester');
            const coursesContainer = document.getElementById('coursesContainer'); // was subjectsContainer
            const coursesPlaceholder = document.getElementById('coursesPlaceholder'); // was subjectsPlaceholder
            const summaryContainer = document.getElementById('summaryContainer'); 
            const totalCoursesInput = document.getElementById('totalCourses'); // was totalSubjectsInput
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            // --- FUNCTIONS ---

            /**
             * --- MODIFIED: Renamed to populateCourses ---
             * Populates and manages course visibility.
             */
            function populateCourses() {
                const selectedBranch = branchSelect.value;
                const selectedSemester = semesterSelect.value;
                const containerId = `courses-${selectedBranch}-${selectedSemester}`;

                // Hide the initial placeholder message if it exists
                if (coursesPlaceholder) {
                    coursesPlaceholder.classList.add('hidden');
                }

                // Hide all other course group containers
                coursesContainer.querySelectorAll('div[data-group]').forEach(div => {
                    div.classList.add('hidden');
                });

                if (!selectedBranch || !selectedSemester) {
                    return; // Do nothing if branch or sem isn't selected
                }

                // Check if this group already exists in the DOM
                let courseGroup = document.getElementById(containerId);

                if (!courseGroup) {
                    // This group hasn't been loaded yet, so create it
                    const courses = coursesByBranchAndSem[selectedBranch] ? coursesByBranchAndSem[selectedBranch][selectedSemester] : undefined;
                    
                    courseGroup = document.createElement('div');
                    courseGroup.id = containerId;
                    courseGroup.setAttribute('data-group', 'courses'); // Mark as a course group
                    
                    if (courses && courses.length > 0) {
                        // --- NEW: Added a header for clarity ---
                        const header = document.createElement('p');
                        header.className = 'text-sm font-semibold text-gray-700';
                        header.textContent = `Branch: ${selectedBranch} - Semester: ${selectedSemester}`;
                        courseGroup.appendChild(header);

                        const innerList = document.createElement('div');
                        innerList.className = 'space-y-2 mt-2 pl-4';
                        courseGroup.appendChild(innerList);

                        courses.forEach(course => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center';
                            
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            // --- CRITICAL CHANGE: name="Subjects" changed to name="Courses" ---
                            input.name = 'Courses'; // Google Sheet column name
                            input.value = `${course.code} - ${course.name}`; // This value is sent
                            input.id = `course-${course.code}`;
                            input.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';

                            const label = document.createElement('label');
                            label.htmlFor = input.id;
                            label.innerHTML = `${course.name} <span class="ml-2 text-sm text-gray-500 font-mono">(${course.code})</span>`;
                            label.className = 'ml-3 block text-sm text-gray-700';

                            div.appendChild(input);
                            div.appendChild(label);
                            innerList.appendChild(div);
                        });
                    } else {
                        courseGroup.innerHTML = `<p class="text-sm text-gray-500">No courses defined for Branch: ${selectedBranch}, Semester: ${selectedSemester}.</p>`;
                    }
                    coursesContainer.appendChild(courseGroup);

                } else {
                    // Group already exists, just show it
                    courseGroup.classList.remove('hidden');
                }
            }
            
            /**
             * --- NEW: Updates the summary box ---
             * This function runs every time a checkbox is clicked.
             */
            function updateSummary() {
                // Find all checked boxes *within the entire coursesContainer*
                const allCheckedBoxes = coursesContainer.querySelectorAll('input[type="checkbox"]:checked');
                
                // Update the (now disabled) "Total Courses" input
                totalCoursesInput.value = allCheckedBoxes.length;

                // Clear the summary and rebuild it
                summaryContainer.innerHTML = '';
                
                if (allCheckedBoxes.length === 0) {
                    summaryContainer.innerHTML = '<p class="text-sm text-gray-500">No courses selected yet.</p>';
                } else {
                    const list = document.createElement('ul');
                    list.className = 'list-disc list-inside space-y-1';
                    
                    allCheckedBoxes.forEach(checkbox => {
                        const item = document.createElement('li');
                        item.className = 'text-sm text-gray-800';
                        item.textContent = checkbox.value; // e.g., "CS101 - Fundamentals of Programming"
                        list.appendChild(item);
                    });
                    summaryContainer.appendChild(list);
                }
            }

            /**
             * Handles the form submission.
             * @param {Event} e - The form submit event.
             */
            async function handleFormSubmit(e) {
                e.preventDefault(); 

                if (formScriptURL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    showError('Form is not configured. Please follow the README to set up the Google Apps Script URL.');
                    return;
                }

                setLoading(true);
                hideMessages();

                try {
                    // This FormData object now correctly captures *all* checked boxes,
                    // even the ones that are hidden, because they all exist in the DOM.
                    const formData = new FormData(form);
                    
                    // --- NEW: Manually set the TotalCourses field in the form data ---
                    // This replaces the disabled input's value
                    formData.set('TotalCourses', totalCoursesInput.value);
                    
                    // --- NEW: Manually append the 'Semester' field ---
                    // The 'Semester' dropdown only shows the *last viewed* semester.
                    // We will remove it from the form data to avoid confusion.
                    formData.delete('Semester');
                    
                    // You could also gather all semesters that have selections
                    const selectedSemesters = new Set();
                    coursesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        // Find the parent group and get its ID
                        const group = cb.closest('div[data-group]');
                        if (group) {
                            const [,,branch, sem] = group.id.split('-');
                            selectedSemesters.add(sem);
                        }
                    });
                    formData.append('SelectedSemesters', Array.from(selectedSemesters).join(', '));
                    

                    const response = await fetch(formScriptURL, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            showSuccess('Form submitted successfully! Your response has been recorded.');
                            form.reset(); // This will uncheck all boxes
                            // --- MODIFIED: Manually reset the UI ---
                            coursesContainer.innerHTML = ''; // Clear all generated course groups
                            if(coursesPlaceholder) coursesPlaceholder.classList.remove('hidden');
                            updateSummary(); // Reset the summary box
                            totalCoursesInput.value = ''; // Reset total courses input
                        } else {
                            throw new Error(result.message || 'Submission failed.');
                        }
                    } else {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showError(`Submission failed. Please check your connection and try again. Error: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            }

            // --- Helper Functions for UI (unchanged) ---

            function setLoading(isLoading) {
                if (isLoading) {
                    submitButton.disabled = true;
                    buttonText.classList.add('hidden');
                    buttonSpinner.classList.remove('hidden');
                } else {
                    submitButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    buttonSpinner.classList.add('hidden');
                }
            }

            function hideMessages() {
                successMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');
            }

            function showSuccess(message) {
                successMessage.querySelector('p').textContent = message;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                window.scrollTo(0, 0); 
            }

            function showError(message) {
                errorMessage.querySelector('p').textContent = message;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                window.scrollTo(0, 0);
            }


            // --- EVENT LISTENERS (updated) ---
            branchSelect.addEventListener('change', populateCourses); // was populateSubjects
            semesterSelect.addEventListener('change', populateCourses); // was populateSubjects
            
            // --- NEW: Listen for changes on the whole container ---
            // This one listener handles all checkbox clicks
            coursesContainer.addEventListener('change', (e) => { // was subjectsContainer
                if (e.target.type === 'checkbox') {
                    updateSummary();
                }
            });
            
            form.addEventListener('submit', handleFormSubmit);

            // --- INITIALIZATION ---
            updateSummary(); // Initial call to set summary (will show "No courses")
        });
    </script>
</body>
</html>

